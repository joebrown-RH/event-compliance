---
- name: Rescue a possible comprimised  Account system
  hosts: rhel
  gather_facts: true
  become: true

  vars:
   my_repo: system_resources.git
   my_repo_host: github.com
   my_repo_user: nmartins0611
   my_repo_url: git@{{ my_repo_host }}:{{ my_repo_user }}/{{ my_repo }}
   my_repo_key: /Users/nmart/.ssh/id_rsa
   id_initial: 0

  tasks:

   - name: Read file 
     slurp:
      src: /tmp/ansible_counter
     register: ansible_counter 
     
   - name: decode counter 
     set_fact:
       counter_value: "{{ ansible_counter.content | b64decode }}"

   - name: Oopsie token setup
     block:

      - name: Refresh token
        file:
         path: /tmp/ansible_counter
         state: absent
     
      - name: Create tmp token file
        file:
         path: /tmp/ansible_counter
         state: touch
 
      - name: Write to file
        lineinfile:
         path: /tmp/ansible_counter
         line: "{{ counter_value|int + 1 }}"
     when: counter_value|int < 5
    
   - name: Retreive user files
     git:
      repo: https://github.com/nmartins0611/system_resources
      dest: /restore
      clone: yes
 
   - name: Restore desired user database files
     copy: 
      src:  /restore/passwd
      dest: /etc/
      owner: root
      group: root
      mode: 0644
      remote_src: yes

   - name: Cleanup 
     file:
       path: /restore
       state: absent

   - name: Isolate node - too many compliance issues
     debug:
       msg: "Oh No! Lock Down ansible_nodename"
